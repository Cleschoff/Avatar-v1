#!/bin/bash
# Git pre-commit hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

echo "üîç Pre-commit: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ .env –≤ –∫–æ–º–º–∏—Ç
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å .env —Ñ–∞–π–ª!"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: git rm --cached .env"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–π
changed_files=$(git diff --cached --name-only)
for file in $changed_files; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ OpenAI –∫–ª—é—á–∏
    if grep -q "sk-[a-zA-Z0-9]\{40,\}" "$file" 2>/dev/null; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω API –∫–ª—é—á –≤ —Ñ–∞–π–ª–µ: $file"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—Ä—è–º—ã–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è (–∫—Ä–æ–º–µ –ø—Ä–∏–º–µ—Ä–æ–≤)
    if grep -q "OPENAI_API_KEY\s*=\s*[\"'][^\"']\+[\"']" "$file" 2>/dev/null; then
        if ! grep -q "your_openai_api_key_here\|dummy_key_for_testing" "$file"; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω–æ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ API –∫–ª—é—á–∞ –≤ —Ñ–∞–π–ª–µ: $file"
            exit 1
        fi
    fi
done

echo "‚úÖ Pre-commit: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!"
exit 0